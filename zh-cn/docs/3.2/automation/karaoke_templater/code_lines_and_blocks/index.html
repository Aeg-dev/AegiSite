<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://aeg-dev.github.io/AegiSite/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://aeg-dev.github.io/AegiSite/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://aeg-dev.github.io/AegiSite/main.fa2ec43ae1b847039e1d1361782f0c3426397729912cb579510777745c5642a5253898bb2423a0355e7a1a0b5e3076f5ecd4630445de5c4a51a7b65253a95460.css integrity="sha512-+i7EOuG4RwOeHRNheC8MNCY5dymRLLV5UQd3dFxWQqUlOJi7JCOgNV56GgteMHb17NRjBEXeXEpRp7ZSU6lUYA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>- Aegisub</title><meta http-equiv=refresh content="0; url=https://aegisite.vercel.app//zh-cn/docs/3.2/automation/karaoke_templater/code_lines_and_blocks/"><meta name=description content="Aegisub is a free, cross-platform open source tool for creating and modifying subtitles. Aegisub makes it quick and easy to time subtitles to audio, and features many powerful tools for styling them, including a built-in real-time video preview."><link rel=canonical href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/automation/karaoke_templater/code_lines_and_blocks/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/doks.png"><meta name=twitter:title content><meta name=twitter:description content="Code lines and blocks in Karaoke Templater allows you to create advanced effects by incorporating small snippets of Lua code. This can range from simple mathematical expressions adding two numbers to complex functions that for example could generate various shapes in cycling colours.
Both code lines and code blocks are run in a separate semi-closed execution environment, meaning they are mostly undisturbed by the primary Lua environment the Karaoke Templater script itself runs in."><meta name=twitter:site content="@henkverlinde"><meta name=twitter:creator content="@henkverlinde"><meta property="og:title" content><meta property="og:description" content="Code lines and blocks in Karaoke Templater allows you to create advanced effects by incorporating small snippets of Lua code. This can range from simple mathematical expressions adding two numbers to complex functions that for example could generate various shapes in cycling colours.
Both code lines and code blocks are run in a separate semi-closed execution environment, meaning they are mostly undisturbed by the primary Lua environment the Karaoke Templater script itself runs in."><meta property="og:type" content="article"><meta property="og:url" content="/zh-cn/docs/3.2/automation/karaoke_templater/code_lines_and_blocks/"><meta property="og:image" content="/zh-cn/doks.png"><meta property="og:site_name" content="Aegisub"><meta property="article:publisher" content="https://www.facebook.com/verlinde.henk"><meta property="article:author" content="https://www.facebook.com/verlinde.henk"><meta property="og:locale" content="en_US"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/aeg-dev.github.io\/AegiSite\/"},{"@type":"ListItem","position":3,"name":"Zh Cn","item":"https:\/\/aeg-dev.github.io\/AegiSite\/\/zh-cn\/"},{"@type":"ListItem","position":4,"name":"Docs","item":"https:\/\/aeg-dev.github.io\/AegiSite\/\/zh-cn\/docs\/"},{"@type":"ListItem","position":5,"name":"3.2","item":"https:\/\/aeg-dev.github.io\/AegiSite\/\/zh-cn\/docs\/3.2\/"},{"@type":"ListItem","position":6,"name":"Automation","item":"https:\/\/aeg-dev.github.io\/AegiSite\/\/zh-cn\/docs\/3.2\/automation\/"},{"@type":"ListItem","position":7,"name":"Karaoke Templater","item":"https:\/\/aeg-dev.github.io\/AegiSite\/\/zh-cn\/docs\/3.2\/automation\/karaoke_templater\/"},{"@type":"ListItem","position":8,"name":"Code Lines and Blocks","item":"https:\/\/aeg-dev.github.io\/AegiSite\/\/zh-cn\/docs\/3.2\/automation\/karaoke_templater\/code_lines_and_blocks\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://aeg-dev.github.io/AegiSite/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://aeg-dev.github.io/AegiSite/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://aeg-dev.github.io/AegiSite/favicon-16x16.png><link rel=manifest href=https://aeg-dev.github.io/AegiSite/site.webmanifest></head><body class="docs single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label>
<a class="navbar-brand order-1 order-md-0 me-auto" href=https://aeg-dev.github.io/AegiSite/zh-cn/>Aegisub</a><div class="order-1 order-md-3"><div class=input-group><select class=custom-select id=inputGroupSelect-language-switching onchange="location=this.value"><option id=en value=https://aeg-dev.github.io/AegiSite/docs/3.2/automation/karaoke_templater/code_lines_and_blocks/>English</option><option id=zh-cn value=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/automation/karaoke_templater/code_lines_and_blocks/ selected>简体中文</option></select></div></div><button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/Aegisub/Aegisub><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2 text-nowrap"><li class=nav-item><a class=nav-link href=https://aeg-dev.github.io/AegiSite/zh-cn/downloads/main/>下载</a></li><li class=nav-item><a class=nav-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/>文档</a></li><li class=nav-item><a class=nav-link href=https://github.com/Aegisub/Aegisub/issues>Bug 追踪</a></li><li class=nav-item><a class=nav-link href=https://aeg-dev.github.io/AegiSite/zh-cn/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=http://blog.aegisub.org/>旧新闻</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><h3>Navigation</h3><ul class=list-unstyled><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/main_page/>Main Page</a></li></ul><h3>Introduction</h3><ul class=list-unstyled><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/about/>What is Aegisub?</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/highlights/>Highlights</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/credits/>Credits</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/support/>Support Aegisub</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/faq/>FAQ</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/tutorials/>Tutorials</a></li></ul><h3>Working with Subtitles</h3><ul class=list-unstyled><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/editing_subtitles/>Editing Subtitles</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/exporting/>Exporting Subtitles</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/attaching_subtitles_to_video/>Applying Subtitles</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/spell_checker/>Spell Checker</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/translation_assistant/>Translation Assistant</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/paste_over/>Paste Over</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/select_lines/>Select Lines</a></li></ul><h3>Typesetting</h3><ul class=list-unstyled><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/typesetting/>Typesetting Introduction</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/video/>Working with Video</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/styles/>Editing styles</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/visual_typesetting/>Visual Typesetting</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/ass_tags/>ASS Override Tags</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/colour_picker/>Colour Picker</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/styling_assistant/>Styling Assistant</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/resolution_resampler/>Resolution Resampler</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/fonts_collector/>Fonts Collector</a></li></ul><h3>Timing</h3><ul class=list-unstyled><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/audio/>Working with Audio</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/timing/>Timing subtitles to audio</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/shift_times/>Shift times</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/timing_post-processor/>Timing Post-Processor</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/kanji_timer/>Kanji Timer</a></li></ul><h3>Automation</h3><ul class=list-unstyled><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/automation/>Overview</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/automation/karaoke_templater/>Karaoke Templater</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/automation/lua/>Lua Reference</a></li></ul><h3>Miscellaneous</h3><ul class=list-unstyled><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/options/>Aegisub Options</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/properties/>Script Properties</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/attachment_manager/>Attachment Manager</a></li><li><a class=docs-link href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/commands/>Commands</a></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#code-lines>Code lines</a><ul><li><a href=#classes-of-code-lines>Classes of code lines</a></li></ul></li><li><a href=#code-blocks>Code blocks</a><ul><li><a href=#hints-for-using-code-blocks>Hints for using code blocks</a></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><h1></h1><p class=lead></p><p>Code lines and blocks in Karaoke Templater allows you to create advanced
effects by incorporating small snippets of Lua code. This can range from simple
mathematical expressions adding two numbers to complex functions that for
example could generate various shapes in cycling colours.</p><p>Both code lines and code blocks are run in a separate semi-closed execution
environment, meaning they are mostly undisturbed by the primary Lua environment
the Karaoke Templater script itself runs in. For an overview of what variables
are available in the code line/block execution environment see: <a href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/automation/karaoke_templater/code_execution_environment/>Code execution environment</a>.</p><h2 id=code-lines>Code lines<a href=#code-lines class=anchor aria-hidden=true>#</a></h2><p>A code line is a special kind of template line. Instead of using the <code>template</code>
keyword in the Effect field it uses the <code>code</code> keyword. A code line contains
only Lua code and does not by itself produce any lines in the resulting file.</p><p>The two primary uses of code lines are:</p><ul><li>Defining/updating variables for use later in templates</li><li>Defining functions for use later in templates</li></ul><p>For example, if you need a random number, but also need to use it twice in one
template, you can use a code line to first generate the number and store it to
a variable, then use that variable in your template line.</p><p>Another example could be defining a function that produces a random colour.</p><h3 id=classes-of-code-lines>Classes of code lines<a href=#classes-of-code-lines class=anchor aria-hidden=true>#</a></h3><p>Like there&rsquo;s multiple classes of template lines there&rsquo;s also multiple classes
of code lines. Some of them are the same, and some only exist for one or the
other.</p><p>You specify the class of the code line in the Effect field after the <code>code</code>
keyword. The possible classes are:</p><dl><dt>once</dt><dd>Code lines in the <code>once</code> class are run exactly one time, before any templates
are applied. This is usually the best place to define functions and general
tables of values you need to look up later. This is the default class, if you
don&rsquo;t specify a class for a code line it&rsquo;s automatically in the <code>once</code> class.</dd><dt>line</dt><dd>Code lines in the <code>line</code> class are run when a new line is encountered. They
are run once per line. They are run interspersed with <code>line</code>/<code>pre-line</code>
templates in the order they appear. (There are no &ldquo;pre-line&rdquo; code lines.)</dd><dt>syl</dt><dd>Code lines in the <code>syl</code> class are run when a new syllable is encountered.
They run once per syllable. They are run interspersed with <code>syl</code> templates.</dd><dt>furi</dt><dd>Code lines in the <code>furi</code> class are run when a new furigana syllable is
encountered. They run once per furigana syllable. They are run interspersed
with <code>furi</code> templates.</dd></dl><p>You <em>cannot</em> have templates with <code>char</code> or <code>multi</code> modifiers run
per-character/per-highlight interspersed with code lines. This is a limitation
of the execution model. This may or may not change in later versions of Karaoke
Templater.</p><h2 id=code-blocks>Code blocks<a href=#code-blocks class=anchor aria-hidden=true>#</a></h2><p>A code block is a block of Lua code within a template line. Code blocks are
used to insert more complex things than can be expressed with <a href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/automation/karaoke_templater/inline_variables/>inline variables</a>.</p><p>Code blocks are required to be single Lua expressions, since a <code>return</code>
statement is automatically prepended to the code. This means you (among other
things) can&rsquo;t do assignments or use <code>if</code> statements within code blocks, you
must use a code line if you want to do any of those things. (There is a way to
do basic conditionals in code blocks though, see below.)</p><p>You create a code block by surrounding the code by exclamation marks, like
this:</p><pre><code>{\t($start,**!syl.start_time+20!**,\bord0)}
</code></pre><p>It is possible to use inline variables within code blocks. They are expanded
before the code block is parsed, so to the Lua interpreter the inline variables
look like regular constants.</p><h3 id=hints-for-using-code-blocks>Hints for using code blocks<a href=#hints-for-using-code-blocks class=anchor aria-hidden=true>#</a></h3><p>Most simple mathematical expressions work just like you&rsquo;d expect them to.
Operator precedence rules are those of regular arithmetic.</p><p>A code block should always return a string or numeric value, if it returns a
boolean, a table or something else it might cause a warning and the resulting
line containing the wrong output.</p><p>To create simple conditionals within code blocks you can use the <code>and</code> and <code>or</code>
operators to chain values and conditions. For example:</p><pre><code>{\k**!syl.duration &gt; 100 and &quot;f&quot; or &quot;&quot;!**$kdur}
</code></pre><p>If the syllable duration is longer than 100 ms the first sub-expression is
true, and the code block returns <tt>&ldquo;f&rdquo;</tt>, otherwise the entire <code>and</code>
expression is false, and the right-hand argument of the <code>or</code> expression is
returned.</p><p>In Lua, <code>and</code> binds stronger than <code>or</code> meaning that <code>and</code> expressions are
evaluated first. In the above expression the effective grouping is like this:
<code>((syl.duration > 100) and "f") or ""</code></p><p>{::template name=&ldquo;automation_navbox&rdquo; /}</p><div class="docs-navigation d-flex justify-content-between"><a href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/automation/karaoke_templater/code_execution_environment/><div class="card my-1"><div class="card-body py-2">&larr;</div></div></a><a class=ms-auto href=https://aeg-dev.github.io/AegiSite/zh-cn/docs/3.2/automation/karaoke_templater/declaring_template_and_code_lines/><div class="card my-1"><div class="card-body py-2">&rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a href=https://www.networkredux.com/>NetworkRedux</a>, <a href=https://gohugo.io/>Hugo</a>, and <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=https://aeg-dev.github.io/AegiSite/zh-cn/privacy-policy/>Privacy</a></li></ul></div></div></div></footer><script src=https://aeg-dev.github.io/AegiSite/js/highlight.min.f80b63ab0a29882dba84d0df18b9afe2e098d916b22007769c8fab9ba080a0b96a6d6c87bff561e64a9b5dde421d934ffe8aee085500f18d8aa183c6294e72bd.js integrity="sha512-+AtjqwopiC26hNDfGLmv4uCY2RayIAd2nI+rm6CAoLlqbWyHv/Vh5kqbXd5CHZNP/oruCFUA8Y2KoYPGKU5yvQ==" crossorigin=anonymous defer></script>
<script src=https://aeg-dev.github.io/AegiSite/main.min.12763ab77eb1a8341afa7dfe9efaa3762a502b8e20262a7bcd0e713140eb441763122246616148895d4dd3da0e15f060137eb3b9334894fa4c74ebec6dc576b0.js integrity="sha512-EnY6t36xqDQa+n3+nvqjdipQK44gJip7zQ5xMUDrRBdjEiJGYWFIiV1N09oOFfBgE36zuTNIlPpMdOvsbcV2sA==" crossorigin=anonymous defer></script></body></html>